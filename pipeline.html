<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>Pipeline - SLKB</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Pipeline";
        var mkdocs_page_input_path = "pipeline.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="index.html" class="icon icon-home"> SLKB
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="index.html">SLKB Pipeline</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="API.html">API</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="Contact%20%26%20Reference.html">Contact & Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="pipeline.html">Pipeline</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#before-getting-started">Before getting started</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#slkb-pipeline-template">SLKB Pipeline Template</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#starting-with-a-local-database-slkb-schema">Starting with a local database (SLKB Schema)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#preparing-data-for-insert">Preparing Data for Insert</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#sgrna-sequences">sgRNA sequences</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dual-sgrna-counts">Dual sgRNA counts</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#calculated-sl-scores">Calculated SL Scores</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#accessing-database">Accessing Database</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#inserting-data-to-database">Inserting Data to Database</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#calculating-sl-scores-and-inserting-to-database">Calculating SL Scores and Inserting to Database</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#initial-steps">Initial steps</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#median-bnb-score">Median-B/NB Score</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sgrna-derived-bnb-score">sgRNA-Derived-B/NB Score</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mageck-score">MAGeCK Score</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#horlbeck-score">Horlbeck Score</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#gemini-score">GEMINI Score</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#query-results-for-one-table">Query Results (For one table)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#query-results-for-all-tables">Query Results (For all tables)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#further-analyses">Further Analyses</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="website.html">SLKB Web Application</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SLKB</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html" class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Pipeline</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/BirkanGokbag/SLKB-Analysis-Pipeline/edit/master/docs/pipeline.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="pipeline">Pipeline</h2>
<h3 id="before-getting-started">Before getting started</h3>
<p>Make sure that your SLKB pipeline package is appropriately installed. In order to run GEMINI Score and MAGeCK Score, you need to follow two additional steps:</p>
<ol>
<li>GEMINI Score: Make sure that you have an R environment with GEMINI installed (version &gt;= 2.1.1), and ggplot2 (will be installed alongside GEMINI).</li>
<li>MAGeCK Score: Make sure that you have MAGECK installed into your system path. </li>
</ol>
<p>If you cannot change your system path and/or need to load R environment seperately (e.g. working on HPC systems), this will be covered later.</p>
<p>You can check whether you can access your R environment and MAGeCK on your computer.</p>
<pre><code>import shutil
shutil.which('R') ## should yield accessed R environment location
shutil.which('mageck') ## should yield MAGeCK location
</code></pre>
<hr>

<h3 id="slkb-pipeline-template">SLKB Pipeline Template</h3>
<p>A template has been prepared that follows through the guide's steps. Feel free to install it from its GitHub <a href="https://github.com/BirkanGokbag/SLKB-Analysis-Pipeline/blob/main/SLKB/files/pipeline.ipynb">link</a> following SLKB package's installation. </p>
<h3 id="starting-with-a-local-database-slkb-schema">Starting with a local database (SLKB Schema)</h3>
<p>First, we start with creating a local database to store the CRISPR synthetic lethality data at hand. SLKB supports mysql and sqlite3 at this time. A URL object is passed that will then create the database via stored schemas.</p>
<pre><code>url_object = sqlalchemy.URL.create(
    &quot;mysql+mysqlconnector&quot;,
    username=&quot;root&quot;,
    password=&quot;password&quot;,  # plain (unescaped) text
    host=&quot;localhost&quot;,
    port = '3306',
    database=&quot;SLKB_mysql&quot;,
)
url_object = 'sqlite:///SLKB_sqlite3'

SLKB_engine = sqlalchemy.create_engine(url_object, pool_size = 0)

# create the database at the url_object
SLKB.create_SLKB(engine = SLKB_engine, db_type = 'sqlite3') # or mysql
</code></pre>
<h3 id="preparing-data-for-insert">Preparing Data for Insert</h3>
<h4 id="sgrna-sequences">sgRNA sequences</h4>
<p>Sequences reference file consists of 3 columns:</p>
<ol>
<li>sgRNA_guide_name: Name of your sgRNA guide</li>
<li>sgRNA_guide_sequence: Sequence for your sgRNA guide</li>
<li>sgRNA_guide_name: Target gene of the sgRNA guide</li>
</ol>
<p>Example:
<center></p>
<table>
<thead>
<tr>
<th align="center">sgRNA_guide_name</th>
<th align="center">sgRNA_guide_sequence</th>
<th align="center">sgRNA_guide_target</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0Safe-safe-ACOC-204550.4522</td>
<td align="center">GTGTATTTGGCTTCCAAAA</td>
<td align="center">control</td>
</tr>
<tr>
<td align="center">0Safe-safe-ACOC-204550.4525</td>
<td align="center">GCATGGCCTCCACTTGCAA</td>
<td align="center">control</td>
</tr>
<tr>
<td align="center">AKT3-1</td>
<td align="center">GTAAGGTAAATCCACATCTTG</td>
<td align="center">AKT3</td>
</tr>
</tbody>
</table>
<p></center></p>
<h4 id="dual-sgrna-counts">Dual sgRNA counts</h4>
<p>Counts file contains X columns. Make sure that your counts annotation matches with the prior sequence information.</p>
<ol>
<li>guide_1: Name of your sgRNA guide at first location</li>
<li>gene_1: Target of your sgRNA guide at first location (CONTROL if targeting control)</li>
<li>guide_2: Name of your sgRNA guide at second location</li>
<li>gene_2: Target of your sgRNA guide at second location (CONTROL if targeting control)</li>
<li>study_origin: Study identifier of the added data (i.e. PubmedID, MYCDKO)</li>
<li>cell_line_origin: Cell line identifier of the added data (e.g. 22Rv1)</li>
<li>study_conditions: Replicate names combined, separated by ';'</li>
<li>count_replicates: sgRNA counts from each replicate combined, separated by ';'</li>
</ol>
<p>Example:</p>
<table>
<thead>
<tr>
<th align="center">guide_1</th>
<th align="center">guide_2</th>
<th align="center">gene_1</th>
<th align="center">gene_2</th>
<th align="center">count_replicates</th>
<th align="center">cell_line_origin</th>
<th align="center">study_conditions</th>
<th align="center">study_origin</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0Safe-safe-ACOC-204550.4522</td>
<td align="center">0Safe-safe-ACOC-204550.4522</td>
<td align="center">0Safe-safe-ACOC</td>
<td align="center">0Safe-safe-ACOC</td>
<td align="center">22;17;36;43</td>
<td align="center">22Rv1</td>
<td align="center">T0_1;T0_2;T12_1;T12_2</td>
<td align="center">36060092</td>
</tr>
<tr>
<td align="center">0Safe-safe-ACOC-204550.4522</td>
<td align="center">0Safe-safe-ACOC-204550.4525</td>
<td align="center">0Safe-safe-ACOC</td>
<td align="center">0Safe-safe-ACOC</td>
<td align="center">57;73;107;98</td>
<td align="center">22Rv1</td>
<td align="center">T0_1;T0_2;T12_1;T12_2</td>
<td align="center">36060092</td>
</tr>
<tr>
<td align="center">0Safe-safe-ACOC-204550.4522</td>
<td align="center">AKT3-1</td>
<td align="center">0Safe-safe-ACOC</td>
<td align="center">AKT3</td>
<td align="center">47;45;68;85</td>
<td align="center">22Rv1</td>
<td align="center">T0_1;T0_2;T12_1;T12_2</td>
<td align="center">36060092</td>
</tr>
</tbody>
</table>
<h4 id="calculated-sl-scores">Calculated SL Scores</h4>
<p>If you have calculated the gene level SL scores for your data already, you can add them here with the following columns. Otherwise, leave empty. </p>
<ol>
<li>gene_1</li>
<li>gene_2</li>
<li>study_origin</li>
<li>cell_line_origin</li>
<li>SL_score</li>
<li>SL_score_cutoff (If NaN, no cutoff applied)</li>
<li>statistical_score</li>
<li>statistical_score_cutoff (If NaN, no cutoff applied)</li>
</ol>
<p>Example:</p>
<table>
<thead>
<tr>
<th align="center">gene_1</th>
<th align="center">gene_2</th>
<th align="center">study_origin</th>
<th align="center">cell_line_origin</th>
<th align="center">SL_score</th>
<th align="center">SL_score_cutoff</th>
<th align="center">statistical_score</th>
<th align="center">statistical_score_cutoff</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">AKT3</td>
<td align="center">AR</td>
<td align="center">36060092</td>
<td align="center">22Rv1</td>
<td align="center">-0.977141</td>
<td align="center">-0.361</td>
<td align="center">NaN</td>
<td align="center">NaN</td>
</tr>
</tbody>
</table>
<hr>

<h3 id="accessing-database">Accessing Database</h3>
<p>Database contents can be accessed externally, and also to insert records. In this pipeline, sqlalchemy will be used to load in the database we have just created. The following codes need to be ran to ensure score calculation is correct. </p>
<pre><code>SLKB_engine = sqlalchemy.create_engine(db_engine)
</code></pre>
<h3 id="inserting-data-to-database">Inserting Data to Database</h3>
<p>Following data preperation, the data is now ready to be processed. We will need to declare two additonal variables before calling the processing function:</p>
<ol>
<li>control_list: List of control targets. These need to be included at counts reference; <strong>gene_1, gene_2 names to use as controls </strong></li>
<li>timepoint_list: A list of two elements; T0 replicates and TEnd replicates. Make sure that the replicate names align.</li>
</ol>
<p>Example:</p>
<pre><code>sequence_ref = ...
counts_ref = ...
scores_ref = ...
study_controls = ['CONTROL']
study_conditions = [['T0_rep1', 'T0_rep2', 'T0_rep3'],
                    ['TEnd_rep1', 'TEnd_rep2', 'TEnd_rep3']]

db_inserts = SLKB.prepare_study_for_export(sequence_ref = sequence_ref, 
                                                     counts_ref = counts_ref,
                                                     scores_ref = scores_ref,
                                                     study_controls = study_controls,
                                                     study_conditions = study_conditions)
</code></pre>
<p>If passed checks successfully, you will notice that db_inserts contains the 3 items: sequence, counts, and score reference. In the event no scores reference was given, a dummy score of 0 was given to each possible gene pair. This is done in order to make sure that gene pairs are unique to each study and cell line.</p>
<p>If SL scores are supplied, by default, SL scores and statistical scores below the specified threshold are deemed as SL (column SL_or_not). Otherwise, they are not SL. You can customize this behavior by accessing the yielding db_inserts['scores_ref'].</p>
<p>By default, control genes supplied in scores file are removed. </p>
<p>Finally, data can be inserted to the database.</p>
<pre><code>SLKB.insert_study_to_db(SLKB_engine, db_inserts)
</code></pre>
<h3 id="calculating-sl-scores-and-inserting-to-database">Calculating SL Scores and Inserting to Database</h3>
<p>Score calculation methods are independent of each other. They can be ran in any order. The details of each scoring method are located in the original paper. Each score is accompanied with two helper functions; checking whether scores have been added to the database and inserting scores to the database.</p>
<ol>
<li>check</li>
<li>insert</li>
</ol>
<h4 id="initial-steps">Initial steps</h4>
<p>SL scores for the gene pairs are calculated for each cell line individually under each study and cell line. First, we filter the counts to obtain the study counts, followed by the cell line counts.</p>
<pre><code>
# read the data

# experiment design
experiment_design = pd.read_sql_query(con=SLKB_engine.connect(), 
                              sql=sqlalchemy.text('SELECT * from CDKO_EXPERIMENT_DESIGN'.lower()), index_col = 'sgRNA_id')
experiment_design.reset_index(drop = True, inplace = True)
experiment_design.index.rename('sgRNA_id', inplace = True)

# counts
counts = pd.read_sql_query(con=SLKB_engine.connect(), 
                              sql=sqlalchemy.text('SELECT * from joined_counts'.lower()), index_col = 'sgRNA_pair_id')

# scores
scores = pd.read_sql_query(con=SLKB_engine.connect(), 
                              sql=sqlalchemy.text('SELECT * from CDKO_ORIGINAL_SL_RESULTS'.lower()), index_col = 'id')
scores.reset_index(drop = True, inplace = True)
scores.index.rename('gene_pair_id', inplace = True)

</code></pre>
<p>For all scores, files will be created in the process. You can specify the location to save your files (default: current working directory). This is done in order to enable quick loading to database for repeated analyses. GEMINI Score and MAGeCK score require file generation in order to run. In the event of updated counts file (e.g., adding additional counts), setting the parameter <code>re_run=TRUE</code> will restart the analysis from scratch. </p>
<h4 id="median-bnb-score">Median-B/NB Score</h4>
<pre><code>if SLKB.check_if_added_to_table(curr_counts.copy(), 'median_nb_score', SLKB_engine):
    median_res = SLKB.run_median_scores(curr_counts.copy(), curr_study = curr_study, curr_cl = curr_cl, store_loc = os.getcwd(), save_dir = 'MEDIAN_Files')
    SLKB.add_table_to_db(curr_counts.copy(), median_res['MEDIAN_NB_SCORE'], 'median_nb_score', SLKB_engine)
    if median_res['MEDIAN_B_SCORE'] is not None:
        SLKB.add_table_to_db(curr_counts.copy(), median_res['MEDIAN_B_SCORE'], 'median_b_score', SLKB_engine)
</code></pre>
<h4 id="sgrna-derived-bnb-score">sgRNA-Derived-B/NB Score</h4>
<pre><code>if not SLKB.check_if_added_to_table(curr_counts.copy(), 'sgrna_derived_nb_score', SLKB_engine):
    sgRNA_res = SLKB.run_sgrna_scores(curr_counts.copy(), curr_study = curr_study, curr_cl = curr_cl, store_loc = os.getcwd(), save_dir = 'sgRNA-DERIVED_Files')
    SLKB.add_table_to_db(curr_counts.copy(), sgRNA_res['SGRNA_DERIVED_NB_SCORE'], 'sgrna_derived_nb_score', SLKB_engine)
    if sgRNA_res['SGRNA_DERIVED_B_SCORE'] is not None:
        SLKB.add_table_to_db(curr_counts.copy(), sgRNA_res['SGRNA_DERIVED_B_SCORE'], 'sgrna_derived_b_score', SLKB_engine)
</code></pre>
<h4 id="mageck-score">MAGeCK Score</h4>
<p>In MAGeCK score, files will be created in process. You can specify the location to save your files (default: current working directory). If you wish to re-run to store new results in its stead, set <code>re_run</code> to True.</p>
<p>MAGeCK is run through a script file at the designated location. If you need to load in any packages or set path to your mageck installation, please supply them to cmd_params.</p>
<pre><code>cmd_params = []
if not SLKB.check_if_added_to_table(curr_counts.copy(), 'mageck_score', SLKB_engine):
    mageck_res = SLKB.run_mageck_score(curr_counts.copy(), curr_study = curr_study, curr_cl = curr_cl, store_loc = os.getcwd(), save_dir = 'MAGECK_Files', command_line_params = cmd_params,re_run = False)
    SLKB.add_table_to_db(curr_counts.copy(), mageck_res['MAGECK_SCORE'], 'mageck_score', SLKB_engine)

</code></pre>
<h4 id="horlbeck-score">Horlbeck Score</h4>
<p>In Horlbeck score, files will be created in process. You can specify the location to save your files (default: current working directory). If you wish to re-run to store new results in its stead, set <code>re_run</code> to True.</p>
<pre><code>if not SLKB.check_if_added_to_table(curr_counts.copy(), 'horlbeck_score', SLKB_engine):
    horlbeck_res = SLKB.run_horlbeck_score(curr_counts.copy(), curr_study = curr_study, curr_cl = curr_cl, store_loc = os.getcwd(), save_dir = 'HORLBECK_Files', do_preprocessing = True, re_run = False)
    SLKB.add_table_to_db(curr_counts.copy(), horlbeck_res['HORLBECK_SCORE'], 'horlbeck_score', SLKB_engine)
</code></pre>
<h4 id="gemini-score">GEMINI Score</h4>
<p>In GEMINI score, files will be created in process. You can specify the location to save your files (default: current working directory). Scores will be stored following GEMINI analysis for quick inserts to the database. If you wish to re-run to store new results in its stead, set <code>re_run</code> to True.</p>
<p>Similarly to MAGeCK, GEMINI is run through a script file at the designated location. If you need to load in any packages or set path to your mageck installation, please supply them to cmd_params.</p>
<pre><code>cmd_params = ['module load R/4.1.0']
if not SLKB.check_if_added_to_table(curr_counts.copy(), 'gemini_score', SLKB_engine):
    gemini_res = SLKB.run_gemini_score(curr_counts.copy(), curr_study = curr_study, curr_cl = curr_cl, store_loc = os.getcwd(), save_dir = 'GEMINI_Files', command_line_params = cmd_params, re_run = False)
    SLKB.add_table_to_db(curr_counts.copy(), gemini_res['GEMINI_SCORE'], 'gemini_score', SLKB_engine)
</code></pre>
<h3 id="query-results-for-one-table">Query Results (For one table)</h3>
<p>Following the score calculations, the query is relatively easy. In this snippet of code, we will access the scores for one of the tables.</p>
<pre><code>score = SLKB.query_result_table(curr_counts.copy(), 'median_b_score', curr_study, curr_cl, SLKB_engine)
</code></pre>
<h3 id="query-results-for-all-tables">Query Results (For all tables)</h3>
<p>Here, we will query all scores using the view within the database.</p>
<pre><code>all_scores = pd.read_sql_query(con=SLKB_engine.connect(), 
                              sql=sqlalchemy.text('SELECT * from calculated_sl_table'))
</code></pre>
<h3 id="further-analyses">Further Analyses</h3>
<p>SLKB web application is available for download to help analyze your generated data. You can access the website at the following <a href="https://slkb.osubmi.org/">link</a>, and it's code at the <a href="https://github.com/BirkanGokbag/SLKB-Analysis-Pipeline/blob/main/SLKB/files/SLKB_webapp.zip">link</a>. To use user generated data, check <code>server.r</code> within the web app.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="website.html" class="btn btn-neutral float-right" title="SLKB Web Application">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/BirkanGokbag/SLKB-Analysis-Pipeline/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="installation.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="website.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme_extra.js" defer></script>
    <script src="js/theme.js" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
